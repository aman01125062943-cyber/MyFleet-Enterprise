{
  "meta": {
    "project": "مدير الأسطول - Enterprise SaaS",
    "date": "2026-02-03",
    "prepared_by": "Product Development Manager"
  },
  "product_overview": "نظام SaaS لإدارة وكالات السيارات متكامل (واجهة React + قاعدة بيانات Supabase) يوفّر إدارة الأسطول، المستخدمين والأدوار، الأصول والمالية، ولوحات تحليلات تفاعلية لتمكين اتخاذ قرارات تشغيلية ومالية سريعة.",
  "core_goals": [
    "توفير إدارة أسطول شاملة (مركبات، سائقون، رحلات) مع واجهة سهلة الاستخدام.",
    "ضمان عزل بيانات متعدد العملاء (multi-tenant) عبر org_id ومنع تسرب البيانات بين الوكالات.",
    "تطبيق نظام مصادقة وصلاحيات مرن (RBAC) يسمح بتخصيص الوصول حسب الأدوار (مسؤول، مستخدم، سائق...).",
    "عرض تقارير ولوحات تحليلات تفاعلية لمؤشرات الأداء المالية والتشغيلية.",
    "إدارة الأصول والمصروفات وربطها بالحسابات المالية لحساب الربحية الصافية.",
    "تأمين جميع العمليات عبر RPCs وقواعد بيانات مع أفضل ممارسات الأمان (Zero Trust، SECURITY DEFINER)."
  ],
  "key_features": [
    "مدير الأسطول: CRUD للمركبات، السائقين، وجدولة الرحلات وإدارة حالات المركبات. (مفاتيح ملفات: App.tsx, components/Dashboard.tsx, types.ts)",
    "المصادقة وإدارة الصلاحيات (Auth & RBAC): تسجيل دخول، إدارة جلسات، أدوار (admin, user, driver) وتحقق على مستوى الخلفية. (lib/supabase.ts, components/Login.tsx, fix_profiles.sql)",
    "لوحة القيادة والتقارير: رسوم بيانية وإحصائيات تفاعلية باستخدام Recharts لعرض الإيرادات، المصروفات، وعدد الرحلات. (components/Dashboard.tsx, components/Analytics.tsx)",
    "إدارة الأصول والمالية: تسجيل الأصول، المصروفات، وتحويلات مالية وحساب صافي الربح. (assets_migration.sql, fix_assets_permissions.sql)",
    "عزل بيانات متعدد الوكالات: استخدام org_id في جميع الجداول وRPCs لفصل البيانات بين الوكالات.",
    "أمان متقدّم: Zero Trust، دوال DB مع SECURITY DEFINER، والتحقق في كل استدعاء RPC.",
    "حاسبة الرحلات: أداة تفاعلية للسائقين لحساب التكاليف لكل رحلة.",
    "قابلة للنشر بسهولة: إعداد Supabase عبر سكربت full_db_setup.sql ومتغيرات بيئة VITE_SUPABASE_URL وVITE_SUPABASE_ANON_KEY.",
    "تقنيات الواجهة: TypeScript + React + Vite + Tailwind CSS مع مكتبات مساعدة: Lucide React، React Router Dom.",
    "قابلية التوسع: تصميم موديولار في الواجهة والـ API لتسهيل إضافة موديولات مستقبلية (الصيانة، تتبع الوقود، جدولة الصيانة)."
  ],
  "user_flow_summary": [
    "تجهيز المؤسسة (Onboarding): مُنشئ الحساب ينشئ وكالة جديدة، تشغيل full_db_setup.sql أو استخدام سكربت التهيئة، وتكوين VITE_SUPABASE_URL وVITE_SUPABASE_ANON_KEY.",
    "تسجيل الدخول والتحقق (Auth): المستخدم يزور صفحة الدخول، يحقق عبر Supabase، ويحصل على جلسة مع دور محدد؛ الواجهات تُعرض بناءً على الصلاحيات.",
    "لوحة القيادة: بعد تسجيل الدخول، يعرض المستخدم ملخص الأداء (إيرادات/مصاريف/عدد الرحلات/حالة المركبات) مع رسوم تفاعلية.",
    "إدارة الأسطول: المسؤول يضيف/يحرر/يحذف مركبات وسائقين، يربط سائق برحلات ويُحدّث حالة المركبة (متاح/في مهمة/صيانة).",
    "تسجيل الرحلات والمالية: السائق أو الموظف يسجل رحلة، يتم حساب التكلفة عبر حاسبة الرحلات، تُسجّل الإيرادات والمصروفات وترتبط بالأصل/المركبة.",
    "إدارة الأصول والمصروفات: إضافة الأصول، رفع فواتير، تصنيف المصروفات وربطها بحسابات وإظهار تأثيرها على الربحية.",
    "تقارير وتحليلات: المستخدم يولد تقارير زمنية (يومي/شهري/سنوي)، يصدر تصديرات CSV/PDF، ويعرض رسوم Recharts للتوجهات.",
    "إدارة الصلاحيات: مسؤول النظام يجهز أدوار وصلاحيات مفصّلة (RBAC) تُخزن في DB وتُطبق عبر RPCs.",
    "نشر وتحديث: نشر الواجهة مع متغيرات Supabase، تشغيل سكربتات SQL (migrations) للتحديثات الهيكلية. "
  ],
  "validation_criteria": [
    "عزل البيانات: اختبار أن المستخدم من وكالة A لا يصل إلى بيانات وكالة B (اختبارات E2E مع org_id).",
    "صلاحيات: كل مسار/RPC يجب أن يرفض الوصول لغير المصرح لهم (اختبارات وحدة وتكامل على RBAC).",
    "وظائف CRUD للأسطول: إضافة/تعديل/حذف مركبة وسائق ورحلة تعمل بشكل صحيح وتنعكس في DB (اختبارات تكاملية).",
    "دقة التقارير: مؤشرات الإيرادات، المصروفات، وعدد الرحلات في لوحة القيادة تتطابق مع سجلات DB (تحقق عبر مجموعات بيانات اختبارية).",
    "هجرة القاعدة: سكربت full_db_setup.sql وملفات migration (assets_migration.sql, fix_assets_permissions.sql, fix_profiles.sql) تنفّذ دون أخطاء على مشروع Supabase جديد.",
    "أمان الدوال: دوال RPC المُعرفة بـ SECURITY DEFINER تعمل فقط مع صلاحيات مُحققة ولا تُعرّض مفاتيح حساسة.",
    "أداء الواجهة: صفحات لوحة القيادة والبحث في الأسطول تعرض نتائج ضمن 300-500ms على بيانات متوسطة (1000-5000 سجل) في بيئة اختبارية.",
    "تجربة المستخدم: تسجيل الدخول، التنقل بين الشاشات الرئيسية، وإجراء عملية CRUD تُنجز بدون أخطاء واضحة في الواجهة (مراجعات يدوية و اختبارات UI).",
    "التوثيق والتشغيل: دليل التشغيل (README) يشرح خطوات إعداد Supabase وتكوين المتغيرات البيئية ويؤدي إلى تطبيق يعمل عند اتباعه خطوة بخطوة."
  ],
  "code_summary": {
    "tech_stack": [
      "TypeScript",
      "React",
      "Vite",
      "Supabase",
      "Tailwind CSS",
      "Lucide React",
      "Recharts",
      "React Router Dom"
    ],
    "features": [
      {
        "name": "مدير الأسطول (Fleet Management)",
        "description": "إدارة المركبات والسائقين والعمليات.",
        "files": [
          "App.tsx",
          "components/Dashboard.tsx",
          "types.ts"
        ]
      },
      {
        "name": "إدارة المستخدمين والصلاحيات (Auth & RBAC)",
        "description": "نظام تسجيل الدخول وإدارة الأدوار (مسؤول، مستخدم).",
        "files": [
          "lib/supabase.ts",
          "components/Login.tsx",
          "fix_profiles.sql"
        ]
      },
      {
        "name": "التقارير ولوحة القيادة (Reporting & Dashboard)",
        "description": "عرض الرسوم البيانية والإحصائيات باستخدام Recharts.",
        "files": [
          "components/Dashboard.tsx",
          "components/Analytics.tsx"
        ]
      },
      {
        "name": "إدارة الأصول (Assets Management)",
        "description": "إدارة الأصول والمصروفات المرتبطة بالأسطول.",
        "files": [
          "assets_migration.sql",
          "fix_assets_permissions.sql"
        ]
      }
    ]
  }
}
